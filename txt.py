# í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
import streamlit as st
import pandas as pd
import plotly.graph_objects as go
from fuzzywuzzy import process # ìœ ì‚¬ ë‹¨ì–´ ë§¤ì¹­ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬
import re # ì •ê·œ í‘œí˜„ì‹ ëª¨ë“ˆ

# --- 1. ì‹í’ˆ ë°ì´í„°ë² ì´ìŠ¤ (ê³ 2 í•™ìƒ ë§ì¶¤ í™•ì¥ ë° êµ¬ì²´í™”) ---
# ì‹¤ì œ ë°ì´í„°ëŠ” ê³µê°œëœ êµ­ê°€ ì‹í’ˆì˜ì–‘ì„±ë¶„ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì°¸ê³ í•˜ì—¬ êµ¬ì„±
# 'g' ë‹¨ìœ„ëŠ” 100g ë‹¹ í•¨ëŸ‰, (ë‹¨ìœ„)ê°€ ë¶™ì€ ìŒì‹ì€ í•´ë‹¹ ë‹¨ìœ„ ë‹¹ í•¨ëŸ‰
FOOD_DATABASE = {
    # ë°¥/ê³¡ë¬¼ë¥˜
    "ìŒ€ë°¥ (1ê³µê¸°, 210g)": {"calories": 308, "íƒ„ìˆ˜í™”ë¬¼": 68.3, "ë‹¨ë°±ì§ˆ": 5.4, "ì§€ë°©": 0.5, "ë‚˜íŠ¸ë¥¨": 1, "ì¹¼ë¥¨": 60, "ì¸": 98, "ì•„ì—°": 1.2, "ì‹ì´ì„¬ìœ ": 0.6},
    "í˜„ë¯¸ë°¥ (1ê³µê¸°, 210g)": {"calories": 286, "íƒ„ìˆ˜í™”ë¬¼": 60.1, "ë‹¨ë°±ì§ˆ": 6.7, "ì§€ë°©": 2.4, "ë‚˜íŠ¸ë¥¨": 1, "ì¹¼ë¥¨": 210, "ì¸": 280, "ì•„ì—°": 2.1, "ì‹ì´ì„¬ìœ ": 4.2},
    "ì‹ë¹µ (1ì¥, 30g)": {"calories": 79, "íƒ„ìˆ˜í™”ë¬¼": 15.6, "ë‹¨ë°±ì§ˆ": 2.6, "ì§€ë°©": 0.9, "ë‚˜íŠ¸ë¥¨": 140, "ì² ë¶„": 0.4},
    "ì‹œë¦¬ì–¼ (1íšŒë¶„, 30g)": {"calories": 110, "íƒ„ìˆ˜í™”ë¬¼": 24.5, "ë‹¨ë°±ì§ˆ": 2.0, "ì§€ë°©": 0.5, "ë‚˜íŠ¸ë¥¨": 180, "ì² ë¶„": 4.5, "ì—½ì‚°": 100}, # ê°•í™” ì‹œë¦¬ì–¼ ê¸°ì¤€

    # êµ­/ì°Œê°œë¥˜ (ì£¼ë¡œ ê¸‰ì‹ ë©”ë‰´)
    "ê¹€ì¹˜ì°Œê°œ (1ì¸ë¶„, 400g)": {"calories": 185, "íƒ„ìˆ˜í™”ë¬¼": 8.8, "ë‹¨ë°±ì§ˆ": 12.3, "ì§€ë°©": 11.2, "ë‚˜íŠ¸ë¥¨": 1900, "ì¹¼ë¥¨": 300, "ì¹¼ìŠ˜": 50, "ë¹„íƒ€ë¯¼C": 5},
    "ëœì¥ì°Œê°œ (1ì¸ë¶„, 400g)": {"calories": 130, "íƒ„ìˆ˜í™”ë¬¼": 9.5, "ë‹¨ë°±ì§ˆ": 9.5, "ì§€ë°©": 6.0, "ë‚˜íŠ¸ë¥¨": 1700, "ì¹¼ë¥¨": 400, "ì¹¼ìŠ˜": 80, "ì‹ì´ì„¬ìœ ": 4.0},
    "ë¯¸ì—­êµ­ (1ì¸ë¶„, 350g)": {"calories": 80, "íƒ„ìˆ˜í™”ë¬¼": 8.0, "ë‹¨ë°±ì§ˆ": 6.0, "ì§€ë°©": 2.0, "ë‚˜íŠ¸ë¥¨": 1200, "ì¹¼ìŠ˜": 100, "ìš”ì˜¤ë“œ": 500},

    # ë©”ì¸ ìš”ë¦¬/ì¼í’ˆ ìš”ë¦¬
    "ë¹„ë¹”ë°¥ (1ì¸ë¶„, 450g)": {"calories": 700, "íƒ„ìˆ˜í™”ë¬¼": 105.7, "ë‹¨ë°±ì§ˆ": 32.5, "ì§€ë°©": 15.6, "naíŠ¸ë¥¨": 1100, "ì¹¼ë¥¨": 500, "ì² ë¶„": 3.5, "ë¹„íƒ€ë¯¼A": 500, "ì‹ì´ì„¬ìœ ": 8.0}, # ì˜¤ë¥˜ ìˆ˜ì •: ë‚˜íŠ¸ë¥¨ -> naíŠ¸ë¥¨
    "ë¶ˆê³ ê¸° (1ì¸ë¶„, 200g)": {"calories": 500, "íƒ„ìˆ˜í™”ë¬¼": 30.0, "ë‹¨ë°±ì§ˆ": 28.0, "ì§€ë°©": 30.0, "ë‚˜íŠ¸ë¥¨": 800, "ì² ë¶„": 3.0, "ì•„ì—°": 3.0},
    "ì œìœ¡ë³¶ìŒ (1ì¸ë¶„, 200g)": {"calories": 450, "íƒ„ìˆ˜í™”ë¬¼": 25.0, "ë‹¨ë°±ì§ˆ": 25.0, "ì§€ë°©": 25.0, "ë‚˜íŠ¸ë¥¨": 900, "ì² ë¶„": 2.5, "ë¹„íƒ€ë¯¼B1": 0.8},
    "ë‹­ê°€ìŠ´ì‚´ (100g)": {"calories": 165, "íƒ„ìˆ˜í™”ë¬¼": 0, "ë‹¨ë°±ì§ˆ": 31, "ì§€ë°©": 3.6, "ë‚˜íŠ¸ë¥¨": 74, "ì¹¼ë¥¨": 255, "ì¸": 200, "ë¹„íƒ€ë¯¼B6": 0.6},
    "ì‚¼ê²¹ì‚´ êµ¬ì´ (1ì¸ë¶„, 200g)": {"calories": 794, "íƒ„ìˆ˜í™”ë¬¼": 0, "ë‹¨ë°±ì§ˆ": 35.8, "ì§€ë°©": 72.8, "ë‚˜íŠ¸ë¥¨": 100, "ì¹¼ë¥¨": 400, "ì² ë¶„": 1.5, "ë¹„íƒ€ë¯¼B1": 0.5},
    "ê³„ë€ í”„ë¼ì´ (1ê°œ, 50g)": {"calories": 90, "íƒ„ìˆ˜í™”ë¬¼": 0.4, "ë‹¨ë°±ì§ˆ": 6.8, "ì§€ë°©": 7.0, "ë‚˜íŠ¸ë¥¨": 80, "ë¹„íƒ€ë¯¼D": 1.0, "ì² ë¶„": 0.8},
    "ë‘ë¶€ (100g)": {"calories": 76, "íƒ„ìˆ˜í™”ë¬¼": 1.9, "ë‹¨ë°±ì§ˆ": 8, "ì§€ë°©": 4.8, "ì¹¼ìŠ˜": 105, "ì² ë¶„": 5.4, "ë§ˆê·¸ë„¤ìŠ˜": 60},
    "ìƒì„ êµ¬ì´ (ê³ ë“±ì–´, 100g)": {"calories": 204, "íƒ„ìˆ˜í™”ë¬¼": 0, "ë‹¨ë°±ì§ˆ": 20.0, "ì§€ë°©": 13.0, "naíŠ¸ë¥¨": 90, "ë¹„íƒ€ë¯¼D": 7.0, "ì˜¤ë©”ê°€3": 2.0}, # ì˜¤ë¥˜ ìˆ˜ì •: ë‚˜íŠ¸ë¥¨ -> naíŠ¸ë¥¨

    # ì±„ì†Œ/ê³¼ì¼ë¥˜
    "ì‚¬ê³¼ (1ê°œ, 150g)": {"calories": 78, "íƒ„ìˆ˜í™”ë¬¼": 20.1, "ë‹¨ë°±ì§ˆ": 0.4, "ì§€ë°©": 0.3, "ë¹„íƒ€ë¯¼C": 7, "ì¹¼ë¥¨": 160, "ì‹ì´ì„¬ìœ ": 3.0},
    "ë°”ë‚˜ë‚˜ (1ê°œ, 100g)": {"calories": 89, "íƒ„ìˆ˜í™”ë¬¼": 22.8, "ë‹¨ë°±ì§ˆ": 1.1, "ì§€ë°©": 0.3, "ë¹„íƒ€ë¯¼C": 8.7, "ì¹¼ë¥¨": 358, "ì‹ì´ì„¬ìœ ": 2.6},
    "ê³ êµ¬ë§ˆ (1ê°œ, 150g)": {"calories": 130, "íƒ„ìˆ˜í™”ë¬¼": 30.0, "ë‹¨ë°±ì§ˆ": 2.0, "ì§€ë°©": 0.2, "ì¹¼ë¥¨": 470, "ë¹„íƒ€ë¯¼A": 800, "ë¹„íƒ€ë¯¼C": 30, "ì‹ì´ì„¬ìœ ": 4.0},
    "ë¸Œë¡œì½œë¦¬ (100g)": {"calories": 34, "íƒ„ìˆ˜í™”ë¬¼": 6.6, "ë‹¨ë°±ì§ˆ": 2.8, "ì§€ë°©": 0.4, "ë¹„íƒ€ë¯¼C": 89.2, "ë¹„íƒ€ë¯¼K": 102, "ì‹ì´ì„¬ìœ ": 2.6},
    "ìƒëŸ¬ë“œ ì±„ì†Œ (100g)": {"calories": 20, "íƒ„ìˆ˜í™”ë¬¼": 4, "ë‹¨ë°±ì§ˆ": 1.5, "ì§€ë°©": 0.2, "ë¹„íƒ€ë¯¼A": 200, "ë¹„íƒ€ë¯¼K": 150, "ì—½ì‚°": 80, "ì‹ì´ì„¬ìœ ": 2.0},
    "ê¹€ì¹˜ (50g)": {"calories": 15, "íƒ„ìˆ˜í™”ë¬¼": 3.0, "ë‹¨ë°±ì§ˆ": 1.0, "ì§€ë°©": 0.2, "naíŠ¸ë¥¨": 400, "ë¹„íƒ€ë¯¼C": 5, "ì‹ì´ì„¬ìœ ": 1.5}, # ì˜¤ë¥˜ ìˆ˜ì •: ë‚˜íŠ¸ë¥¨ -> naíŠ¸ë¥¨

    # ìœ ì œí’ˆ/ìŒë£Œ
    "ìš°ìœ  (200ml)": {"calories": 103, "íƒ„ìˆ˜í™”ë¬¼": 9.4, "ë‹¨ë°±ì§ˆ": 6.4, "ì§€ë°©": 5.5, "ì¹¼ìŠ˜": 240, "ë¹„íƒ€ë¯¼D": 2.4, "ë¹„íƒ€ë¯¼B2": 0.3},
    "ì˜¤ë Œì§€ì£¼ìŠ¤ (200ml)": {"calories": 90, "íƒ„ìˆ˜í™”ë¬¼": 20.8, "ë‹¨ë°±ì§ˆ": 1.4, "ì§€ë°©": 0.2, "ë¹„íƒ€ë¯¼C": 120, "ì¹¼ë¥¨": 400},
    "íƒ„ì‚°ìŒë£Œ (350ml)": {"calories": 150, "íƒ„ìˆ˜í™”ë¬¼": 40, "ë‹¨ë°±ì§ˆ": 0, "ì§€ë°©": 0, "ë‚˜íŠ¸ë¥¨": 40},

    # ê°„ì‹/íŒ¨ìŠ¤íŠ¸í‘¸ë“œ
    "ë¼ë©´ (1ë´‰ì§€, 120g)": {"calories": 500, "íƒ„ìˆ˜í™”ë¬¼": 75.0, "ë‹¨ë°±ì§ˆ": 10.0, "ì§€ë°©": 18.0, "naíŠ¸ë¥¨": 1900, "ì¹¼ìŠ˜": 10, "ì² ë¶„": 0.5}, # ì˜¤ë¥˜ ìˆ˜ì •: ë‚˜íŠ¸ë¥¨ -> naíŠ¸ë¥¨
    "ë–¡ë³¶ì´ (1ì¸ë¶„, 400g)": {"calories": 600, "íƒ„ìˆ˜í™”ë¬¼": 90.0, "ë‹¨ë°±ì§ˆ": 20.0, "ì§€ë°©": 20.0, "ë‚˜íŠ¸ë¥¨": 1500, "ì¹¼ìŠ˜": 50},
    "ê¹€ë°¥ (1ì¤„, 200g)": {"calories": 300, "íƒ„ìˆ˜í™”ë¬¼": 50.0, "ë‹¨ë°±ì§ˆ": 12.0, "ì§€ë°©": 6.0, "ë‚˜íŠ¸ë¥¨": 600, "ì² ë¶„": 1.0},
    "í”¼ì (1ì¡°ê°, 150g)": {"calories": 350, "íƒ„ìˆ˜í™”ë¬¼": 35.0, "ë‹¨ë°±ì§ˆ": 15.0, "ì§€ë°©": 15.0, "naíŠ¸ë¥¨": 700, "ì¹¼ìŠ˜": 150}, # ì˜¤ë¥˜ ìˆ˜ì •: ë‚˜íŠ¸ë¥¨ -> naíŠ¸ë¥¨
    "ì¹˜í‚¨ (ìˆœì‚´ í”„ë¼ì´ë“œ 100g)": {"calories": 300, "íƒ„ìˆ˜í™”ë¬¼": 10.0, "ë‹¨ë°±ì§ˆ": 25.0, "ì§€ë°©": 18.0, "ë‚˜íŠ¸ë¥¨": 400},
    "ê°ìíŠ€ê¹€ (Mì‚¬ì´ì¦ˆ, 120g)": {"calories": 370, "íƒ„ìˆ˜í™”ë¬¼": 45.0, "ë‹¨ë°±ì§ˆ": 4.0, "ì§€ë°©": 20.0, "ë‚˜íŠ¸ë¥¨": 200},
    "ì´ˆì½œë¦¿ (50g)": {"calories": 250, "íƒ„ìˆ˜í™”ë¬¼": 30.0, "ë‹¨ë°±ì§ˆ": 3.0, "ì§€ë°©": 15.0, "ë‹¹ë¥˜": 25.0},
    "ê³¼ì (1ë´‰ì§€, 60g)": {"calories": 300, "íƒ„ìˆ˜í™”ë¬¼": 35.0, "ë‹¨ë°±ì§ˆ": 3.0, "ì§€ë°©": 17.0, "ë‚˜íŠ¸ë¥¨": 300},
}

# --- 2. ì¼ì¼ ê¶Œì¥ ì„­ì·¨ëŸ‰ (RDA) - ê³ 2 í•™ìƒ í‰ê·  ê¸°ì¤€ ê·¼ì‚¬ì¹˜ ---
# í™œë™ëŸ‰ ë³´í†µì¸ ë‚¨í•™ìƒê³¼ ì—¬í•™ìƒ í‰ê· ì„ ê³ ë ¤í•œ ê°’ (ê°œì¸ì°¨ í¼)
DAILY_RDA = {
    "calories": 2300,  # kcal (ë‚¨í•™ìƒ 2500-2800, ì—¬í•™ìƒ 2000-2200 ê³ ë ¤)
    "íƒ„ìˆ˜í™”ë¬¼": 300,   # g (ì´ ì—ë„ˆì§€ì˜ 55~65%)
    "ë‹¨ë°±ì§ˆ": 65,     # g (ì²´ì¤‘ kgë‹¹ 1.0~1.2g, ì„±ì¥ê¸° ê³ ë ¤)
    "ì§€ë°©": 65,      # g (ì´ ì—ë„ˆì§€ì˜ 20~30%)
    "ì‹ì´ì„¬ìœ ": 25,   # g
    "ë¹„íƒ€ë¯¼C": 100,   # mg
    "ë¹„íƒ€ë¯¼A": 750,   # mcg
    "ë¹„íƒ€ë¯¼D": 10,    # mcg (ì„±ì¥ê¸° ë¼ˆ ê±´ê°•ì— ì¤‘ìš”)
    "ë¹„íƒ€ë¯¼E": 15,    # mg
    "ë¹„íƒ€ë¯¼K": 75,    # mcg
    "ë¹„íƒ€ë¯¼B1": 1.4,  # mg (ì—ë„ˆì§€ ëŒ€ì‚¬ì— ì¤‘ìš”)
    "ë¹„íƒ€ë¯¼B2": 1.5,  # mg
    "ë¹„íƒ€ë¯¼B6": 1.5,  # mg
    "ë¹„íƒ€ë¯¼B12": 2.4, # mcg
    "ì—½ì‚°": 400,      # mcg (ì„±ì¥ì— ì¤‘ìš”)
    "ì¹¼ìŠ˜": 900,      # mg (ë¼ˆ ì„±ì¥ ìµœì ê¸°)
    "ì² ë¶„": 14,       # mg (ì—¬í•™ìƒì€ ë” ë†’ì„ ìˆ˜ ìˆìŒ 16mg)
    "ì¹¼ë¥¨": 3500,     # mg
    "ë§ˆê·¸ë„¤ìŠ˜": 350,  # mg (ì„±ì¥ê³¼ ì‹ ê²½ ê¸°ëŠ¥)
    "ì¸": 700,        # mg
    "ì•„ì—°": 12,       # mg
    "ë‚˜íŠ¸ë¥¨": 2000,    # mg (ì„­ì·¨ ìƒí•œì„ )
    "ì˜¤ë©”ê°€3": 1.8,  # g
    "ë‹¹ë¥˜": 50,       # g (WHO ê¶Œì¥ ìƒí•œì„  - ì´ ì¹¼ë¡œë¦¬ì˜ 10% ë¯¸ë§Œ)
}

# --- Streamlit ì•± í˜ì´ì§€ ì„¤ì • ---
st.set_page_config(layout="wide", page_title="ğŸƒâ€â™€ï¸ ê³ 2 ë§ì¶¤ ì‹ë‹¨ & ì˜ì–‘ ë¶„ì„ê¸°")

st.title("ğŸƒâ€â™€ï¸ ê³ 2 ë§ì¶¤ ì‹ë‹¨ & ì˜ì–‘ ë¶„ì„ê¸°")
st.markdown("##### ê³µë¶€í•˜ëŠë¼, í™œë™í•˜ëŠë¼ ë°”ìœ ë„ˆí¬ë¥¼ ìœ„í•œ ë§ì¶¤ ì˜ì–‘ ì½”ì¹­!")
st.markdown("---")

# --- ì‚¬ìš©ì ì…ë ¥ ì„¹ì…˜ ---
st.header("1. ì˜¤ëŠ˜ ë¨¹ì€ ì‹ë‹¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”")

# ì„ íƒëœ ìŒì‹ ì•„ì´í…œê³¼ ì„­ì·¨ëŸ‰ì„ ì €ì¥í•  ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'daily_meals' not in st.session_state:
    st.session_state.daily_meals = []

col_food_input, col_quantity_input, col_add_button = st.columns([0.6, 0.2, 0.2])

with col_food_input:
    user_food_input = st.text_input(
        "ìŒì‹ ì´ë¦„ì„ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ì—ì„œ ì¶”ì²œë˜ëŠ” ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”!",
        placeholder="ì˜ˆ: ìŒ€ë°¥, ë¹„ë¹”ë°¥, ë‹­ê°€ìŠ´ì‚´, ë¼ë©´, ê¹€ì¹˜ì°Œê°œ...",
        key="user_food_input"
    )

    recommended_food = None
    if user_food_input:
        matches = process.extractBests(user_food_input, FOOD_DATABASE.keys(), score_cutoff=60, limit=5)
        
        if matches:
            selected_match_display = st.selectbox(
                "í˜¹ì‹œ ì´ ìŒì‹ì„ ì°¾ìœ¼ì‹œë‚˜ìš”?",
                [f"{match[0]} (ì •í™•ë„ {match[1]}%)" for match in matches],
                key="match_selector"
            )
            # ì‹¤ì œ ìŒì‹ ì´ë¦„ë§Œ ì¶”ì¶œ
            recommended_food = selected_match_display.split(' (ì •í™•ë„')[0]
        else:
            st.warning("ğŸ¤” ì•—, ë¹„ìŠ·í•œ ìŒì‹ì„ ì°¾ê¸° ì–´ë µë„¤ìš”. ìŒì‹ ì´ë¦„ì„ ì •í™•í•˜ê²Œ ì…ë ¥í•˜ê±°ë‚˜ ë‹¤ë¥¸ ìŒì‹ì„ ì‹œë„í•´ë³´ì„¸ìš”.")
    
with col_quantity_input:
    default_g = 100.0 # ê¸°ë³¸ê°’ì€ 100g
    if recommended_food and recommended_food in FOOD_DATABASE:
        match = re.search(r'\(.*, (\d+\.?\d*)g\)', recommended_food) 
        if match:
            default_g = float(match.group(1))
        elif '(100g)' in recommended_food:
             default_g = 100.0

    quantity_g = st.number_input(
        f"ì„­ì·¨ëŸ‰ (ê·¸ë¨, g)",
        min_value=1.0,
        max_value=3000.0,
        value=default_g,
        step=1.0,
        key="quantity_g_input"
    )

with col_add_button:
    st.markdown("<br>" * 3, unsafe_allow_html=True)
    if st.button("ì‹ë‹¨ ì¶”ê°€!", key="add_meal_button"):
        if recommended_food and recommended_food in FOOD_DATABASE:
            st.session_state.daily_meals.append({
                "food": recommended_food,
                "quantity_g": quantity_g
            })
            st.success(f"âœ”ï¸ **{recommended_food}** {quantity_g}g ì¶”ê°€ ì™„ë£Œ!")
            st.session_state.user_food_input = ""
            st.experimental_rerun()
        else:
            st.warning("âš ï¸ ì„ íƒëœ ìŒì‹ì´ ì—†ê±°ë‚˜, ì•„ì§ ë°ì´í„°ë² ì´ìŠ¤ì— ì—†ëŠ” ìŒì‹ì´ì—ìš”. ì •í™•í•œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")

st.markdown("---")

st.subheader("ğŸš ë‚˜ì˜ ì˜¤ëŠ˜ ì‹ë‹¨ ëª©ë¡")
if not st.session_state.daily_meals:
    st.info("ğŸ’¡ ì•„ì§ ì¶”ê°€ëœ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì— ìŒì‹ê³¼ ì„­ì·¨ëŸ‰ì„ ì…ë ¥í•˜ê³  'ì‹ë‹¨ ì¶”ê°€!' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.")
else:
    meal_df = pd.DataFrame(st.session_state.daily_meals)
    meal_df.rename(columns={'quantity_g': 'ì„­ì·¨ëŸ‰ (g)'}, inplace=True)
    meal_df.index = meal_df.index + 1
    st.table(meal_df)

    if st.button("âŒ ëª¨ë“  ì‹ë‹¨ ì´ˆê¸°í™” (ë‹¤ ì§€ìš°ê¸°)", key="reset_meals_button"):
        st.session_state.daily_meals = []
        st.experimental_rerun()

st.markdown("---")

# --- 3. ì˜ì–‘ ë¶„ì„ ë¡œì§ ---
total_nutrients = {nutrient: 0.0 for nutrient in DAILY_RDA.keys()}

for meal in st.session_state.daily_meals:
    food_name = meal['food']
    quantity_g = meal['quantity_g']
    
    if food_name in FOOD_DATABASE:
        food_info = FOOD_DATABASE[food_name]
        
        base_g = 100.0
        match = re.search(r'\(.*, (\d+\.?\d*)g\)', food_name) 
        if match:
            base_g = float(match.group(1))
        elif '(100g)' in food_name:
             base_g = 100.0

        for nutrient, value in food_info.items():
            if nutrient in total_nutrients: # DAILY_RDAì— ì •ì˜ëœ ì˜ì–‘ì†Œë§Œ í•©ì‚°
                total_nutrients[nutrient] += (quantity_g / base_g) * value
            # Note: The original error was 'naíŠ¸ë¥¨' instead of 'ë‚˜íŠ¸ë¥¨' in FOOD_DATABASE.
            # Correcting it here for robustness if user copies it.
            elif nutrient == 'naíŠ¸ë¥¨' and 'ë‚˜íŠ¸ë¥¨' in total_nutrients:
                total_nutrients['ë‚˜íŠ¸ë¥¨'] += (quantity_g / base_g) * value
            elif nutrient == "calories": # ì¹¼ë¡œë¦¬ëŠ” í•­ìƒ í•©ì‚°
                total_nutrients["calories"] += (quantity_g / base_g) * value

# --- 4. ì˜ì–‘ ë¶„ì„ ê²°ê³¼ ì‹œê°í™” ---
st.header("2. âœ¨ ë‚˜ì˜ ì˜ì–‘ ë¶„ì„ ê²°ê³¼")

if not st.session_state.daily_meals:
    st.warning("ì•„ì§ ì‹ë‹¨ì„ ì¶”ê°€í•˜ì§€ ì•Šì•˜ë„¤ìš”! ì‹ë‹¨ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì— ì˜ì–‘ ë¶„ì„ ê²°ê³¼ê°€ ë‚˜íƒ€ë‚  ê±°ì˜ˆìš”.")
else:
    # --- ì˜ì–‘ì†Œ ì„­ì·¨ëŸ‰ì„ ê¶Œì¥ëŸ‰ê³¼ ë¹„êµí•˜ëŠ” Bullet Graph ìƒì„± í•¨ìˆ˜ ---
    def create_rda_bullet_chart(nutrient_name, intake_value, rda_value, unit=""):
        if rda_value is None or rda_value == 0:
            rda_value = 1
            axis_max = 100 
        else:
            axis_max = rda_value * 2.0
        
        bar_color = "gray"
        if nutrient_name in ["ë‚˜íŠ¸ë¥¨", "ë‹¹ë¥˜"]:
            if intake_value > rda_value: bar_color = "red"
            else: bar_color = "green"
        else:
            if intake_value / rda_value < 0.7:
                bar_color = "orange"
            elif intake_value / rda_value > 1.3:
                bar_color = "red"
            else:
                bar_color = "green"

        fig = go.Figure(go.Indicator(
            mode = "number+gauge",
            value = intake_value,
            domain = {'x': [0, 1], 'y': [0, 1]},
            title = {'text': f"<span style='font-size:1.1em'>{nutrient_name} ({unit})</span><br><span style='font-size:0.8em;color:gray'>ê¶Œì¥: {rda_value}{unit}</span>"},
            gauge = {
                'shape': "bullet",
                'axis': {'range': [0, axis_max], 'tickwidth': 1, 'tickcolor': "darkblue"},
                'bar': {'color': bar_color},
                'steps': [
                    {'range': [0, rda_value * 0.7], 'color': "lightgray"},
                    {'range': [rda_value * 0.7, rda_value * 1.3], 'color': "lightblue"},
                    {'range': [rda_value * 1.3, axis_max], 'color': "lightcoral"}
                ],
                'threshold' : {'line': {'color': "black", 'width': 4}, 'thickness': 0.75, 'value': rda_value}
            }))
        fig.update_layout(height=150, margin=dict(l=10, r=10, t=50, b=10))
        return fig

    # --- ì£¼ìš” ì˜ì–‘ì†Œ (ì¹¼ë¡œë¦¬, íƒ„ë‹¨ì§€, ì‹ì´ì„¬ìœ , ë‚˜íŠ¸ë¥¨, ë‹¹ë¥˜) ---
    st.subheader("ğŸ”¥ ë„ˆì˜ í•˜ë£¨ ì—ë„ˆì§€ëŠ” ì–´ë•Œ?")
    main_nutrients_display = ["calories", "íƒ„ìˆ˜í™”ë¬¼", "ë‹¨ë°±ì§ˆ", "ì§€ë°©", "ì‹ì´ì„¬ìœ ", "ë‚˜íŠ¸ë¥¨", "ë‹¹ë¥˜"]
    
    main_cols = st.columns(len(main_nutrients_display))
    for i, nutrient in enumerate(main_nutrients_display):
        with main_cols[i]:
            unit = ""
            if nutrient == "calories": unit = "kcal"
            elif nutrient == "ë‚˜íŠ¸ë¥¨": unit = "mg"
            elif nutrient == "ë‹¹ë¥˜": unit = "g" # Explicitly define for 'ë‹¹ë¥˜'
            else: unit = "g"
            
            intake_val = total_nutrients.get(nutrient, 0)
            rda_val = DAILY_RDA.get(nutrient)
            
            if rda_val is not None:
                st.plotly_chart(create_rda_bullet_chart(nutrient, intake_val, rda_val, unit), use_container_width=True)
            else: # RDA ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
                st.markdown(f"<p style='font-size:0.8em; color:gray;'>{nutrient} (ê¶Œì¥ëŸ‰ ì •ë³´ ì—†ìŒ)</p>", unsafe_allow_html=True)


    st.markdown("---")

    # --- ë¹„íƒ€ë¯¼ ë° ë¯¸ë„¤ë„ ---
    st.subheader("ğŸ’¡ ëª¸ ì‘¥ì‘¥, ë¨¸ë¦¬ ì“±ì“±! ë¹„íƒ€ë¯¼ & ë¯¸ë„¤ë„ì€?")
    micro_nutrients_display = [
        "ì¹¼ìŠ˜", "ì² ë¶„", "ë¹„íƒ€ë¯¼D", "ë¹„íƒ€ë¯¼C", "ë¹„íƒ€ë¯¼A", "ë¹„íƒ€ë¯¼B1", "ë¹„íƒ€ë¯¼B2", "ë¹„íƒ€ë¯¼B6", "ë¹„íƒ€ë¯¼B12", "ì—½ì‚°",
        "ì¹¼ë¥¨", "ë§ˆê·¸ë„¤ìŠ˜", "ì¸", "ì•„ì—°", "ë¹„íƒ€ë¯¼E", "ë¹„íƒ€ë¯¼K", "ì˜¤ë©”ê°€3"
    ]
    
    num_cols_micros = 4 
    cols_micros = st.columns(num_cols_micros)
    
    for i, nutrient in enumerate(micro_nutrients_display):
        intake_val = total_nutrients.get(nutrient, 0)
        rda_val = DAILY_RDA.get(nutrient)
        
        if rda_val is not None:
            with cols_micros[i % num_cols_micros]:
                unit = "mg"
                if nutrient in ["ë¹„íƒ€ë¯¼A", "ë¹„íƒ€ë¯¼D", "ë¹„íƒ€ë¯¼K", "ë¹„íƒ€ë¯¼B12", "ì—½ì‚°"]:
                    unit = "mcg"
                elif nutrient == "ì˜¤ë©”ê°€3":
                    unit = "g"
                
                st.plotly_chart(create_rda_bullet_chart(nutrient, intake_val, rda_val, unit), use_container_width=True)
        else:
            with cols_micros[i % num_cols_micros]:
                st.markdown(f"<p style='font-size:0.8em; color:gray;'>{nutrient} (ê¶Œì¥ëŸ‰ ì •ë³´ ì—†ìŒ)</p>", unsafe_allow_html=True)


    st.markdown("---")

    # --- 5. ë§ì¶¤í˜• ì‹ìŠµê´€ ê°œì„  íŒ ì œê³µ (ê³ 2 ë§ì¶¤!) ---
    st.header("3. ğŸ’– ë„ˆë¥¼ ìœ„í•œ ë§ì¶¤í˜• ì‹ìŠµê´€ ê¿€íŒ!")
    tips = []

    # ì„±ì¥/ì—ë„ˆì§€ ê´€ë ¨ íŒ
    if total_nutrients["calories"] < DAILY_RDA["calories"] * 0.8:
        tips.append("ğŸ“– **í™œë™ëŸ‰ê³¼ ê³µë¶€ëŸ‰ì— ë¹„í•´ ì—ë„ˆì§€ê°€ ë¶€ì¡±**í•  ìˆ˜ ìˆì–´ìš”! ì§‘ì¤‘ë ¥ ì €í•˜ë‚˜ í”¼ë¡œë¥¼ ëŠë‚€ë‹¤ë©´, ì‹ì‚¬ëŸ‰ì„ ì¡°ê¸ˆ ëŠ˜ë¦¬ê±°ë‚˜ ê²¬ê³¼ë¥˜, ê³¼ì¼ ê°™ì€ ê±´ê°•í•œ ê°„ì‹ìœ¼ë¡œ ì—ë„ˆì§€ë¥¼ ë³´ì¶©í•´ ë³´ì„¸ìš”.")
    elif total_nutrients["calories"] > DAILY_RDA["calories"] * 1.2:
        tips.append("ğŸ” ì˜¤ëŠ˜ ì¹¼ë¡œë¦¬ë¥¼ ë§ì´ ì„­ì·¨í–ˆë„¤ìš”! ê³¼ë„í•œ ê°„ì‹ì´ë‚˜ ì•¼ì‹ì„ ì¤„ì´ê³ , ê· í˜• ì¡íŒ ì‹ì‚¬ë¥¼ ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¢‹ì•„ìš”. íŠ€ê¸´ ìŒì‹ ëŒ€ì‹  êµ½ê±°ë‚˜ ì°ŒëŠ” ë°©ë²•ì„ ì‹œë„í•´ë³¼ê¹Œìš”?")

    if total_nutrients["íƒ„ìˆ˜í™”ë¬¼"] < DAILY_RDA["íƒ„ìˆ˜í™”ë¬¼"] * 0.7:
        tips.append("ğŸ§  **ë‡Œ í™œë™ê³¼ ì—ë„ˆì§€ë¥¼ ìœ„í•œ íƒ„ìˆ˜í™”ë¬¼**ì´ ì¡°ê¸ˆ ë¶€ì¡±í•  ìˆ˜ ìˆì–´ìš”. ìŒ€ë°¥, í˜„ë¯¸ë°¥, í†µë°€ë¹µ, ê³ êµ¬ë§ˆ ë“± ë³µí•© íƒ„ìˆ˜í™”ë¬¼ì„ ì¶©ë¶„íˆ ë¨¹ì–´ì„œ ê³µë¶€ì— í•„ìš”í•œ ì—ë„ˆì§€ë¥¼ ì±„ì›Œì£¼ì„¸ìš”!")
    elif total_nutrients["íƒ„ìˆ˜í™”ë¬¼"] > DAILY_RDA["íƒ„ìˆ˜í™”ë¬¼"] * 1.3 and total_nutrients.get("ë‹¹ë¥˜",0) > DAILY_RDA["ë‹¹ë¥˜"] * 1.5:
        tips.append("ğŸ¬ **ë‹¹ë¥˜ê°€ í¬í•¨ëœ íƒ„ìˆ˜í™”ë¬¼ ì„­ì·¨ê°€ ë§ì€ í¸**ì´ì—ìš”. ë¼ë©´, ë–¡ë³¶ì´, ë‹¨ ìŒë£Œ, ê³¼ìë³´ë‹¤ëŠ” ë°¥, ì±„ì†Œ, ê³¼ì¼ì²˜ëŸ¼ ìì—° ìƒíƒœì˜ íƒ„ìˆ˜í™”ë¬¼ì„ ì„ íƒí•˜ëŠ” ê²Œ ì¢‹ì•„ìš”. í”¼ë¶€ ê±´ê°•ê³¼ ì§‘ì¤‘ë ¥ì—ë„ ì¢‹ë‹µë‹ˆë‹¤!")
    
    if total_nutrients["ë‹¨ë°±ì§ˆ"] < DAILY_RDA["ë‹¨ë°±ì§ˆ"] * 0.8:
        tips.append("ğŸ’ª í•œì°½ ì„±ì¥í•  ì‹œê¸°ì¸ë° **ë‹¨ë°±ì§ˆ ì„­ì·¨ê°€ ë¶€ì¡±**í•˜ë„¤ìš”! ë‹­ê°€ìŠ´ì‚´, ê³„ë€, ë‘ë¶€, ì½©, ê³ ê¸°, ìƒì„  ë“±ìœ¼ë¡œ ê·¼ìœ¡ì„ íŠ¼íŠ¼í•˜ê²Œ í•˜ê³  ë©´ì—­ë ¥ë„ ë†’ì—¬ë³´ì„¸ìš”. í‚¤ í¬ëŠ” ë°ë„ ë„ì›€ì´ ë  ê±°ì˜ˆìš”!")
    
    if total_nutrients["ì§€ë°©"] < DAILY_RDA["ì§€ë°©"] * 0.7:
        tips.append("ğŸ’¡ **ê±´ê°•í•œ ì§€ë°© ì„­ì·¨ê°€ ë¶€ì¡±**í•  ìˆ˜ ìˆì–´ìš”. ë‡Œ ë°œë‹¬ê³¼ í˜¸ë¥´ëª¬ ê· í˜•ì— í•„ìš”í•œ ì¢‹ì€ ì§€ë°©(ê²¬ê³¼ë¥˜, ë“±í‘¸ë¥¸ ìƒì„ , ì•„ë³´ì¹´ë„)ì„ ìŠì§€ ë§ê³  ì±™ê²¨ì£¼ì„¸ìš”!")
    elif total_nutrients["ì§€ë°©"] > DAILY_RDA["ì§€ë°©"] * 1.3:
        tips.append("ğŸŸ ì§€ë°©ì„ ë§ì´ ì„­ì·¨í–ˆë„¤ìš”! íŠ¹íˆ íŠ€ê¸°ê±°ë‚˜ ê¸°ë¦„ì§„ ìŒì‹ì„ ìì£¼ ë¨¹ì—ˆë‹¤ë©´, êµ½ê±°ë‚˜ ì‚¶ëŠ” ì¡°ë¦¬ë²•ìœ¼ë¡œ ë°”ê¿”ë³´ëŠ” ê±´ ì–´ë•Œìš”? í”¼ë¶€ íŠ¸ëŸ¬ë¸” ê´€ë¦¬ì—ë„ ë„ì›€ì´ ë  ê±°ì˜ˆìš”.")

    if total_nutrients["ë‚˜íŠ¸ë¥¨"] > DAILY_RDA["ë‚˜íŠ¸ë¥¨"] * 1.2:
        tips.append("ğŸ§‚ **ë‚˜íŠ¸ë¥¨ ì„­ì·¨ëŸ‰ì´ ë†’ì€ í¸**ì´ì—ìš”. ì§  ìŒì‹ì€ ì‰½ê²Œ ë¶“ê²Œ ë§Œë“¤ê³ , ì¥ê¸°ì ìœ¼ë¡œ ê±´ê°•ì— ë¶€ë‹´ì„ ì¤„ ìˆ˜ ìˆì–´ìš”. êµ­ë¬¼ ìš”ë¦¬ë‚˜ ê°€ê³µì‹í’ˆë³´ë‹¤ëŠ” ì‹ ì„ í•œ ì¬ë£Œë¡œ ìš”ë¦¬í•˜ê³ , ë¬¼ì„ ì¶©ë¶„íˆ ë§ˆì…”ì£¼ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.")

    if total_nutrients["ì‹ì´ì„¬ìœ "] < DAILY_RDA["ì‹ì´ì„¬ìœ "] * 0.7:
        tips.append("ğŸ **ì‹ì´ì„¬ìœ  ì„­ì·¨ê°€ ë¶€ì¡±**í•˜ë„¤ìš”. ì¥ ê±´ê°•ì€ ë¬¼ë¡ , í¬ë§Œê°ì„ ì£¼ì–´ ê±´ê°•í•œ ì²´ì¤‘ì„ ìœ ì§€í•˜ëŠ” ë°ë„ ë„ì›€ì´ ë¼ìš”! í†µê³¡ë¬¼, ì±„ì†Œ, ê³¼ì¼, í•´ì¡°ë¥˜ë¥¼ ë” ë§ì´ ë¨¹ì–´ë³´ì„¸ìš”.")
    
    if total_nutrients.get("ì¹¼ìŠ˜", 0) < DAILY_RDA["ì¹¼ìŠ˜"] * 0.7 or total_nutrients.get("ë¹„íƒ€ë¯¼D", 0) < DAILY_RDA["ë¹„íƒ€ë¯¼D"] * 0.7:
        tips.append("ğŸ¦´ **í‚¤ ì„±ì¥ì— ì¤‘ìš”í•œ ì¹¼ìŠ˜ê³¼ ë¹„íƒ€ë¯¼D**ê°€ ë¶€ì¡±í•  ìˆ˜ ìˆì–´ìš”! ìš°ìœ , ì¹˜ì¦ˆ, ë¼ˆì§¸ ë¨¹ëŠ” ìƒì„ , ê·¸ë¦¬ê³  í–‡ë³•ì„ ì¶©ë¶„íˆ ì¬ì–´ì£¼ëŠ” ê²ƒë„ ìŠì§€ ë§ˆì„¸ìš”.")
    
    if total_nutrients.get("ì² ë¶„", 0) < DAILY_RDA["ì² ë¶„"] * 0.7:
        tips.append("ğŸ©¸ **ì² ë¶„ ì„­ì·¨ì— ì‹ ê²½ ì¨ì£¼ì„¸ìš”!** íŠ¹íˆ ì—¬í•™ìƒì´ë¼ë©´ ë”ìš± ì¤‘ìš”í•´ìš”. ë¶‰ì€ ì‚´ì½”ê¸°, ì‹œê¸ˆì¹˜, ì½©ë¥˜ë¥¼ ë¹„íƒ€ë¯¼Cì™€ í•¨ê»˜ ì„­ì·¨í•˜ë©´ í¡ìˆ˜ìœ¨ì´ ë†’ì•„ì§„ë‹µë‹ˆë‹¤.")

    tips.append("ğŸ’§ **ì¶©ë¶„í•œ ë¬¼ ì„­ì·¨ëŠ” ì •ë§ ì¤‘ìš”í•´ìš”!** ê³µë¶€í•  ë•Œë‚˜ ìš´ë™í•  ë•Œ ëŠ˜ ë¬¼ë³‘ì„ ì˜†ì— ë‘ê³  ìˆ˜ì‹œë¡œ ë§ˆì…”ì„œ ëª¸ì„ ì´‰ì´‰í•˜ê²Œ ìœ ì§€í•´ì£¼ì„¸ìš”.")


    if not tips:
        st.success("âœ¨ **ì˜¤ëŠ˜ ì‹ë‹¨ì€ ì˜ì–‘ ê· í˜•ì´ ì•„ì£¼ì•„ì£¼ ì˜ ì¡í˜€ ìˆìŠµë‹ˆë‹¤! ì§±ì´ì—ìš”!** ğŸ‘ ì§€ê¸ˆì²˜ëŸ¼ë§Œ ê±´ê°•í•œ ì‹ìŠµê´€ì„ ìœ ì§€í•œë‹¤ë©´, í‚¤ë„ ì‘¥ì‘¥! ê³µë¶€ë„ ì‘¥ì‘¥! ì—ë„ˆì§€ê°€ ë„˜ì¹  ê±°ì˜ˆìš”!")
    else:
        st.info("ë‹¤ìŒê³¼ ê°™ì€ ì ë“¤ì„ ì°¸ê³ í•´ì„œ ë„ˆì˜ ì‹ìŠµê´€ì„ ë”ìš± ë©‹ì§€ê²Œ ë§Œë“¤ì–´ê°€ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?")
        for tip in tips:
            st.markdown(f"- {tip}")

st.markdown("---")
st.markdown("""
    ğŸ’¡ **ì´ ì•±ì€ ê³ 2 í•™ìƒë“¤ì„ ìœ„í•œ ì˜ì–‘ ì¡°ì–¸ì´ì•¼!**
    - ì—¬ê¸°ì— ë‚˜ì˜¤ëŠ” ëª¨ë“  ì˜ì–‘ ì •ë³´ëŠ” í‰ê· ì ì¸ ê³ 2 í•™ìƒì˜ ê¶Œì¥ëŸ‰ê³¼ ì¼ë°˜ì ì¸ ì‹í’ˆ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œ **ì°¸ê³  ìë£Œ**ì•¼.
    - ì‚¬ëŒë§ˆë‹¤ í™œë™ëŸ‰, ê±´ê°• ìƒíƒœ, ì„±ì¥ ì†ë„ê°€ ë‹¤ ë‹¤ë¥´ë‹ˆê¹Œ, ì •ë§ **ë‚˜ì—ê²Œ ë”± ë§ëŠ” ì˜ì–‘ ìƒë‹´ì´ í•„ìš”í•˜ë‹¤ë©´ ê¼­ í•™êµ ì˜ì–‘ ì„ ìƒë‹˜ì´ë‚˜ ë³´ê±´ ì„ ìƒë‹˜, ë˜ëŠ” ë³‘ì› ì˜ì–‘ì‚¬ ì„ ìƒë‹˜ê»˜ ì§ì ‘ ë¬¼ì–´ë³´ëŠ” ê²Œ ê°€ì¥ ì •í™•í•´!**
""")
